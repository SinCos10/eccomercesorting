<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App de Separação</title>
    <meta name="description" content="Aplicativo para gestão de separação de pedidos e produtos">
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192x192.png" type="image/png">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --background-color: #f3f4f6;
            --text-color: #1f2937;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .container {
            width: 100%;
            padding: 16px;
            margin-bottom: 70px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 16px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .menu-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin-top: 24px;
        }
        
        .menu-item {
            background-color: white;
            border-radius: 8px;
            padding: 24px 16px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        
        .menu-item:active {
            transform: scale(0.98);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .menu-item h2 {
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        .menu-item p {
            color: var(--text-color);
            opacity: 0.8;
            font-size: 0.9rem;
        }
        
        .icon {
            font-size: 2rem;
            margin-bottom: 12px;
            color: var(--primary-color);
        }
        
        .screen {
            display: none;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        
        .active {
            display: block;
        }
        
        .back-button {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            position: absolute;
            left: 16px;
            top: 16px;
            cursor: pointer;
        }
        
        .sub-header {
            background-color: var(--primary-color);
            color: white;
            padding: 16px;
            text-align: center;
            position: relative;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .card h3 {
            color: var(--primary-color);
            margin-bottom: 8px;
        }
        
        .button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 1rem;
            cursor: pointer;
            display: inline-block;
            text-align: center;
            margin: 8px 0;
            width: 100%;
        }
        
        .button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        
        .button-success {
            background-color: var(--success-color);
        }
        
        .button-warning {
            background-color: var(--warning-color);
        }
        
        .button-danger {
            background-color: var(--danger-color);
        }
        
        .button-small {
            padding: 8px 12px;
            font-size: 0.9rem;
            width: auto;
        }
        
        .input-group {
            margin-bottom: 16px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .list-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .list-item:last-child {
            border-bottom: none;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-pendente {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-andamento {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .status-concluido {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .scanner-container {
            width: 100%;
            height: 250px;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 16px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        #barcode-scanner {
            width: 100%;
            height: 100%;
        }

        #barcode-scanner video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .scanner-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            flex-direction: column;
            position: absolute;
            top: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .scanner-animation {
            width: 100%;
            height: 2px;
            background-color: var(--primary-color);
            position: relative;
            animation: scan 2s infinite linear;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 40%;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            box-shadow: 0 0 0 2000px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes scan {
            0% { top: 0; }
            50% { top: 250px; }
            100% { top: 0; }
        }
        
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .footer-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            color: #6b7280;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        .footer-button.active {
            color: var(--primary-color);
        }
        
        .footer-button:disabled {
            color: #d1d5db;
            cursor: not-allowed;
        }
        
        .footer-button i {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tab-buttons {
            display: flex;
            justify-content: space-around;
            margin: 16px 0;
        }
        
        .tab-button {
            padding: 8px 16px;
            border: none;
            background: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
        }
        
        .tab-button.active {
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .product-info {
            flex: 1;
            display: flex;
            align-items: center;
        }
        
        .product-actions {
            display: flex;
            gap: 8px;
        }
        
        .status-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .status-pending {
            background-color: #d1d5db;
        }
        
        .status-completed {
            background-color: var(--success-color);
        }
        
        .action-button {
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .action-button.scan {
            background-color: var(--primary-color);
            color: white;
        }
        
        .action-button.edit {
            background-color: var(--warning-color);
            color: white;
        }
        
        .action-button.delete {
            background-color: var(--danger-color);
            color: white;
        }
        
        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--success-color);
            border-radius: 4px;
        }
        
        .history-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .history-date {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .history-details {
            font-size: 0.9rem;
            color: #6b7280;
        }
        
        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 16px;
            background-color: #f8fafc;
            transition: all 0.3s;
        }
        
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary-color);
            background-color: #eff6ff;
        }
        
        .upload-icon {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .file-info {
            flex: 1;
            overflow: hidden;
        }
        
        .file-name {
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-details {
            font-size: 0.8rem;
            color: #64748b;
        }
        
        .file-actions {
            display: flex;
            gap: 6px;
        }
        
        .action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .btn-view {
            background-color: #dbeafe;
            color: var(--primary-color);
        }
        
        .btn-edit {
            background-color: #fef3c7;
            color: var(--warning-color);
        }
        
        .btn-delete {
            background-color: #fee2e2;
            color: var(--danger-color);
        }
        
        .btn-export {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: #64748b;
        }
        
        .empty-icon {
            font-size: 2rem;
            color: #cbd5e1;
            margin-bottom: 10px;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification-success {
            border-left: 4px solid var(--success-color);
        }
        
        .notification-error {
            border-left: 4px solid var(--danger-color);
        }
        
        .notification-icon {
            margin-right: 8px;
            font-size: 1rem;
        }
        
        .filter-buttons {
            display: flex;
            gap: 8px;
            margin: 12px 0;
            flex-wrap: wrap;
        }
        
        .filter-button {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .filter-button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .install-button {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 99;
            cursor: pointer;
        }
        
        .report-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }
        
        .report-content {
            background-color: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .report-detail {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
        }
        
        .report-label {
            font-weight: 500;
        }
        
        .operator-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }
        
        .operator-content {
            background-color: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
        }
        
        .manual-input-container {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }
        
        .manual-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .manual-button {
            padding: 12px 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .quantity-badge {
            background-color: #e5e7eb;
            color: #374151;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 8px;
        }
        
        .scanner-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .scanner-toggle {
            flex: 1;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
        }
        
        .scanner-toggle.inactive {
            background-color: #9ca3af;
        }
        
        .progress-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .progress-text {
            font-weight: 500;
            color: var(--primary-color);
        }
        
        .progress-count {
            display: flex;
            gap: 16px;
        }
        
        .count-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .count-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .count-label {
            font-size: 0.8rem;
            color: #6b7280;
        }
        
        .count-pending {
            color: var(--warning-color);
        }
        
        .count-completed {
            color: var(--success-color);
        }
        
        .product-quantity {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }
        
        .quantity-progress {
            width: 60px;
            height: 6px;
            background-color: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .quantity-progress-fill {
            height: 100%;
            background-color: var(--success-color);
            border-radius: 3px;
        }
        
        .list-selector {
            margin-bottom: 16px;
        }
        
        .product-match {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 8px;
        }
        
        .match-found {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .match-notfound {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        
        .product-preview {
            max-height: 300px;
            overflow-y: auto;
            margin: 16px 0;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px;
        }
        
        .product-preview-item {
            padding: 8px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
        }
        
        .product-preview-item:last-child {
            border-bottom: none;
        }
        
        .manual-quantity-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .quantity-btn.remove {
            background-color: var(--danger-color);
        }
        
        @media (max-width: 600px) {
            .file-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .file-actions {
                margin-top: 8px;
                width: 100%;
                justify-content: space-between;
            }
            
            .action-btn {
                flex: 1;
                text-align: center;
            }
            
            .filter-buttons {
                flex-direction: column;
            }
            
            .manual-input-container {
                flex-direction: column;
            }
            
            .scanner-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="operator-modal" id="operatorModal">
        <div class="operator-content">
            <h2>Identificação do Operador</h2>
            <p>Por favor, informe seu nome para registrar suas atividades:</p>
            
            <div class="input-group">
                <label for="operator-name">Seu Nome</label>
                <input type="text" id="operator-name" placeholder="Digite seu nome completo">
            </div>
            
            <button class="button button-success" onclick="setOperator()">
                <i class="fas fa-check"></i> Confirmar
            </button>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <header>
            <h1>App de Separação</h1>
        </header>
        
        <div class="container">
            <div class="menu-container">
                <div class="menu-item" onclick="startSeparation()">
                    <div class="icon"><i class="fas fa-box"></i></div>
                    <h2>Separação de Itens</h2>
                    <p>Registro de separação individual de produtos</p>
                </div>
                
                <div class="menu-item" onclick="alert('EM DESENVOLVIMENTO')">
                    <div class="icon"><i class="fas fa-clipboard-list" style="color: var(--danger-color);"></i></div>
                    <h2>Separação de Pedidos</h2>
                    <p>Controle completo de pedidos</p>
                </div>
                
                <div class="menu-item" onclick="alert('EM DESENVOLVIMENTO')">
                    <div class="icon"><i class="fas fa-tasks" style="color: var(--danger-color);"></i></div>
                    <h2>Confecção de Pedidos</h2>
                    <p>Preparação de pedidos</p>
                </div>
                
                <div class="menu-item" onclick="showScreen('importacao-listas')">
                    <div class="icon"><i class="fas fa-file-import"></i></div>
                    <h2>Importação de Listas</h2>
                    <p>Carregar listas de pedidos via PDF</p>
                </div>
                
                <div class="menu-item" onclick="showScreen('adicionar-produto')">
                    <div class="icon"><i class="fas fa-plus-circle"></i></div>
                    <h2>Adicionar Produto</h2>
                    <p>Cadastrar produtos manualmente</p>
                </div>
                
                <div class="menu-item" onclick="showScreen('relatorios')">
                    <div class="icon"><i class="fas fa-chart-bar"></i></div>
                    <h2>Relatórios</h2>
                    <p>Visualizar processos concluídos</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="separacao-itens" class="screen">
        <div class="sub-header">
            <button class="back-button" onclick="cancelSeparation()"><i class="fas fa-arrow-left"></i></button>
            <h1>Separação de Itens</h1>
        </div>
        
        <div class="container">
            <div class="list-selector">
                <div class="input-group">
                    <label for="lista-selecionada">Lista de Separação</label>
                    <select id="lista-selecionada" onchange="loadSelectedList()">
                        <option value="">-- Selecione uma lista --</option>
                    </select>
                </div>
            </div>
            
            <div class="card">
                <h3>Leitor de Código de Barras</h3>
                
                <div class="scanner-controls">
                    <button id="start-scanner" class="scanner-toggle" onclick="initBarcodeScanner()">
                        <i class="fas fa-camera"></i> Ativar Câmera
                    </button>
                    <button id="stop-scanner" class="scanner-toggle inactive" onclick="stopBarcodeScanner()">
                        <i class="fas fa-stop"></i> Parar Câmera
                    </button>
                </div>
                
                <div class="scanner-container">
                    <div id="barcode-scanner"></div>
                    <div class="scanner-overlay"></div>
                    <div class="scanner-placeholder" id="scanner-placeholder">
                        <i class="fas fa-camera" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p>Clique em "Ativar Câmera" para iniciar leitor</p>
                    </div>
                </div>
                
                <h4>Ou digite o código manualmente:</h4>
                <div class="manual-input-container">
                    <input type="text" id="barcode-input" class="manual-input" placeholder="Digite o código" onkeypress="handleBarcodeInput(event)">
                    <button class="manual-button" onclick="processBarcode()">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="progress-container">
                    <h3>Itens para Separar</h3>
                    <div class="progress-count">
                        <div class="count-item">
                            <span class="count-value count-pending" id="pending-count">0</span>
                            <span class="count-label">Pendentes</span>
                        </div>
                        <div class="count-item">
                            <span class="count-value count-completed" id="completed-count">0</span>
                            <span class="count-label">Concluídos</span>
                        </div>
                    </div>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                
                <div class="filter-buttons">
                    <button class="filter-button active" onclick="filterProducts('all', this)">Todos</button>
                    <button class="filter-button" onclick="filterProducts('pending', this)">Pendentes</button>
                    <button class="filter-button" onclick="filterProducts('completed', this)">Concluídos</button>
                    <button class="filter-button" onclick="sortProducts('name', this)">Ordenar por Nome</button>
                    <button class="filter-button" onclick="sortProducts('quantity', this)">Ordenar por Quantidade</button>
                </div>
                
                <div id="products-list">
                    </div>
                
                <button class="button button-success" id="finish-button" onclick="finishSeparation()" disabled>
                    <i class="fas fa-check-circle"></i> Finalizar Separação
                </button>
            </div>
        </div>
    </div>
    
    <div id="importacao-listas" class="screen">
        <div class="sub-header">
            <button class="back-button" onclick="showScreen('main-screen')"><i class="fas fa-arrow-left"></i></button>
            <h1>Importação de Listas</h1>
        </div>
        
        <div class="container">
            <div class="card">
                <h3>Importar Nova Lista</h3>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <h3>Arraste seu arquivo PDF aqui</h3>
                    <p>ou</p>
                    <button class="button" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-upload"></i> Selecione um arquivo
                    </button>
                    <input type="file" id="fileInput" class="file-input" accept=".pdf" onchange="handleFileSelect(event)">
                </div>
                
                <div id="filePreview" style="display: none;">
                    <h4>Arquivo selecionado:</h4>
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-name" id="fileName">arquivo.pdf</div>
                            <div class="file-details" id="fileDetails">Tamanho: 0 KB</div>
                        </div>
                        <div class="file-actions">
                            <button class="action-btn btn-view" onclick="analyzePDF()">
                                <i class="fas fa-search"></i> Analisar
                            </button>
                            <button class="action-btn btn-delete" onclick="clearFile()">
                                <i class="fas fa-trash"></i> Remover
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3>Análise de Produtos</h3>
                <div id="analysisResults">
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h4>Nenhum arquivo analisado</h4>
                        <p>Faça o upload de um PDF para analisar os produtos</p>
                    </div>
                </div>
            </div>
            
            <div class="card" id="importedProductsCard" style="display: none;">
                <h3>Produtos Importados</h3>
                <div class="product-preview" id="productPreview">
                    </div>
                <div class="input-group">
                    <label for="listName">Nome da Lista</label>
                    <input type="text" id="listName" placeholder="Digite um nome para a lista">
                </div>
                <button class="button button-success" onclick="saveImportedList()">
                    <i class="fas fa-save"></i> Salvar Lista
                </button>
            </div>
        </div>
    </div>
    
    <div id="adicionar-produto" class="screen">
        <div class="sub-header">
            <button class="back-button" onclick="showScreen('main-screen')"><i class="fas fa-arrow-left"></i></button>
            <h1>Adicionar Produto</h1>
        </div>
        
        <div class="container">
            <div class="card">
                <h3>Cadastrar Produto Manualmente</h3>
                
                <div class="input-group">
                    <label for="product-name">Nome do Produto</label>
                    <input type="text" id="product-name" placeholder="Ex: NIVEA Antissinais 50g">
                </div>
                
                <div class="input-group">
                    <label for="product-code">Código do Produto</label>
                    <input type="text" id="product-code" placeholder="Ex: 7891000055123">
                </div>
                
                <button class="button button-success" onclick="addProduct()">
                    <i class="fas fa-plus"></i> Adicionar Produto
                </button>
            </div>

            <div class="card">
                <h3>Importar Produtos em Lote (TXT)</h3>
                <div class="upload-area" id="importProductsArea">
                    <div class="upload-icon">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <h3>Arraste seu arquivo TXT aqui</h3>
                    <p>Formato: NOME DO PRODUTO, CÓDIGO</p>
                    <button class="button button-small" onclick="document.getElementById('products-file-import').click()">
                        <i class="fas fa-upload"></i> Selecione um arquivo
                    </button>
                    <input type="file" id="products-file-import" class="file-input" accept=".txt" onchange="handleProductsFileSelect(event)">
                </div>
                
                <div class="input-group">
                    <label for="products-content-import">Ou cole o conteúdo aqui:</label>
                    <textarea id="products-content-import" rows="5" placeholder="NOME DO PRODUTO, 123456&#10;PRODUTO KIT, 123456/234567"></textarea>
                </div>
                
                <button class="button" onclick="importProducts()">
                    <i class="fas fa-file-import"></i> Importar Produtos
                </button>
            </div>
            
            <div class="card">
                <h3>Produtos Cadastrados</h3>
                
                <div class="input-group">
                    <input type="text" id="product-search" placeholder="Buscar produto..." oninput="searchProducts(this.value)">
                </div>
                
                <div id="products-list-registered">
                    </div>
            </div>
        </div>
    </div>

    <div id="relatorios" class="screen">
        <div class="sub-header">
            <button class="back-button" onclick="showScreen('main-screen')"><i class="fas fa-arrow-left"></i></button>
            <h1>Relatórios</h1>
        </div>
        
        <div class="container">
            <div class="card">
                <h3>Processos Concluídos</h3>
                <p>Visualize e exporte os relatórios de processos finalizados</p>
                
                <div id="reports-list">
                    </div>
            </div>
        </div>
    </div>

    <div class="report-modal" id="reportModal">
        <div class="report-content">
            <div class="report-header">
                <h2>Relatório de Separação</h2>
                <button class="close-button" onclick="closeReport()">&times;</button>
            </div>
            
            <div class="report-detail">
                <span class="report-label">Responsável:</span>
                <span id="report-responsavel">Operador</span>
            </div>
            
            <div class="report-detail">
                <span class="report-label">Data:</span>
                <span id="report-data">01/01/2023</span>
            </div>
            
            <div class="report-detail">
                <span class="report-label">Hora de Início:</span>
                <span id="report-inicio">00:00:00</span>
            </div>
            
            <div class="report-detail">
                <span class="report-label">Hora de Término:</span>
                <span id="report-termino">00:00:00</span>
            </div>
            
            <div class="report-detail">
                <span class="report-label">Tempo Total:</span>
                <span id="report-tempo">00:00:00</span>
            </div>
            
            <div class="report-detail">
                <span class="report-label">Itens Processados:</span>
                <span id="report-itens">0/0</span>
            </div>
            
            <div class="report-detail">
                <span class="report-label">Eficiência:</span>
                <span id="report-eficiencia">0%</span>
            </div>
            
            <button class="button button-success" onclick="closeReport()">OK</button>
            <button class="button" onclick="exportReport()">
                <i class="fas fa-download"></i> Exportar como TXT
            </button>
        </div>
    </div>
    
    <div class="footer">
        <button class="footer-button active" onclick="showScreen('main-screen')">
            <i class="fas fa-home"></i>
            <span>Início</span>
        </button>
        
        <button class="footer-button" onclick="alert('EM DESENVOLVIMENTO')">
            <i class="fas fa-clipboard-list"></i>
            <span>Pedidos</span>
        </button>
        
        <button class="footer-button" onclick="showScreen('importacao-listas')">
            <i class="fas fa-file-import"></i>
            <span>Importar</span>
        </button>
        
        <button class="footer-button" onclick="showScreen('relatorios')">
            <i class="fas fa-chart-bar"></i>
            <span>Relatórios</span>
        </button>
    </div>
    
    <div class="notification notification-success" id="successNotification">
        <i class="fas fa-check-circle notification-icon"></i>
        <span id="successMessage">Operação realizada com sucesso!</span>
    </div>
    
    <div class="notification notification-error" id="errorNotification">
        <i class="fas fa-exclamation-circle notification-icon"></i>
        <span id="errorMessage">Ocorreu um erro na operação.</span>
    </div>

    <script>
        // Variáveis globais
        let currentOperator = '';
        let lists = JSON.parse(localStorage.getItem('lists')) || {};
        let currentList = null;
        let selectedFile = null;
        let scannerActive = false;
        let importedProducts = [];
        let registeredProducts = JSON.parse(localStorage.getItem('registeredProducts')) || [];
        let currentFilter = 'all';
        
        // Variáveis para o scanner
        let canScan = true;
        let lastScannedCode = null;
        let lastScanTime = null;

        // Variáveis para Relatórios
        let startTime = null;
        let endTime = null;
        let completedReports = [];

        // Inicialização quando a página carrega
        window.onload = function() {
            // Verificar se há um operador salvo
            const savedOperator = localStorage.getItem('operator');
            if (savedOperator) {
                currentOperator = savedOperator;
                document.getElementById('operatorModal').style.display = 'none';
                showScreen('main-screen');
            } else {
                document.getElementById('operatorModal').style.display = 'flex';
            }
            
            // Carregar listas salvas
            loadSavedLists();
            
            // Carregar produtos cadastrados
            loadRegisteredProducts();

            // Carregar relatórios salvos
            loadReports();
            
            // Configurar eventos de arrastar e soltar para upload
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); e.target.classList.add('dragover'); });
            uploadArea.addEventListener('dragleave', (e) => { e.target.classList.remove('dragover'); });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                e.target.classList.remove('dragover');
                if (e.dataTransfer.files.length) handleDroppedFile(e.dataTransfer.files[0]);
            });

            // Configurar eventos de arrastar e soltar para importação de produtos
            const importProductsArea = document.getElementById('importProductsArea');
            importProductsArea.addEventListener('dragover', (e) => { e.preventDefault(); e.target.classList.add('dragover'); });
            importProductsArea.addEventListener('dragleave', (e) => { e.target.classList.remove('dragover'); });
            importProductsArea.addEventListener('drop', (e) => {
                e.preventDefault();
                e.target.classList.remove('dragover');
                if (e.dataTransfer.files.length) handleProductsFileSelect({ target: e.dataTransfer });
            });
        };
        
        // Função para definir o operador
        function setOperator() {
            const operatorName = document.getElementById('operator-name').value.trim();
            if (operatorName) {
                currentOperator = operatorName;
                localStorage.setItem('operator', operatorName);
                document.getElementById('operatorModal').style.display = 'none';
                showNotification('success', `Bem-vindo, ${operatorName}!`);
                showScreen('main-screen');
            } else {
                showNotification('error', 'Por favor, informe seu nome.');
            }
        }
        
        // Função para mostrar uma notificação
        function showNotification(type, message) {
            const notification = document.getElementById(`${type}Notification`);
            const messageElement = document.getElementById(`${type}Message`);
            
            messageElement.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Função para alternar entre telas
        function showScreen(screenId) {
            // Esconder todas as telas
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Mostrar a tela solicitada
            document.getElementById(screenId).classList.add('active');
            
            // Atualizar botões do rodapé
            document.querySelectorAll('.footer-button').forEach(button => {
                button.classList.remove('active');
            });
            
            const buttonMap = {
                'main-screen': document.querySelector('.footer-button:nth-child(1)'),
                'separacao-pedidos': document.querySelector('.footer-button:nth-child(2)'),
                'importacao-listas': document.querySelector('.footer-button:nth-child(3)'),
                'relatorios': document.querySelector('.footer-button:nth-child(4)')
            };

            if (buttonMap[screenId]) {
                buttonMap[screenId].classList.add('active');
            }
            
            // Ações específicas para cada tela
            if (screenId === 'separacao-itens') {
                updateProductsList();
            } else if (screenId === 'adicionar-produto') {
                loadRegisteredProducts();
            } else if (screenId === 'relatorios') {
                loadReports();
            }
        }
        
        // Função para lidar com a seleção de arquivo
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/pdf') {
                selectedFile = file;
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileDetails').textContent = `Tamanho: ${Math.round(file.size / 1024)} KB`;
                document.getElementById('filePreview').style.display = 'block';
                showNotification('success', 'Arquivo PDF selecionado com sucesso!');
            } else {
                showNotification('error', 'Por favor, selecione um arquivo PDF válido.');
            }
        }
        
        // Função para lidar com arquivo arrastado e solto
        function handleDroppedFile(file) {
            if (file && file.type === 'application/pdf') {
                selectedFile = file;
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileDetails').textContent = `Tamanho: ${Math.round(file.size / 1024)} KB`;
                document.getElementById('filePreview').style.display = 'block';
                showNotification('success', 'Arquivo PDF selecionado com sucesso!');
            } else {
                showNotification('error', 'Por favor, selecione um arquivo PDF válido.');
            }
        }
        
        // Função para limpar o arquivo selecionado
        function clearFile() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('filePreview').style.display = 'none';
            document.getElementById('analysisResults').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon"><i class="fas fa-search"></i></div>
                    <h4>Nenhum arquivo analisado</h4>
                    <p>Faça o upload de um PDF para analisar os produtos</p>
                </div>`;
            document.getElementById('importedProductsCard').style.display = 'none';
        }
        
        // Função para analisar o PDF
        function analyzePDF() {
            if (!selectedFile) {
                showNotification('error', 'Nenhum arquivo selecionado para análise.');
                return;
            }
            showNotification('success', 'Analisando PDF...');
            setTimeout(() => {
                const extractedData = simulatePDFExtraction();
                processExtractedProducts(extractedData);
            }, 1500);
        }
        
function simulatePDFExtraction() {
    return [
        { name: "ANTISSINAIS 50G NIVEA - Creme Facial Antissinais - 50g", quantity: 1 },
        { name: "ANTISSINAIS 50G NIVEA - Creme Facial Antissinais - 50g", quantity: 1 },
        { name: "ANTISSINAIS 50G NIVEA - Creme Facial Antissinais - 50g", quantity: 14 },
        { name: "ANTISSINAIS 50G NIVEA - Creme Facial Antissinais - 50g", quantity: 1 },
        { name: "NUTRITIVO 50G NIVEA - Creme Facial Nutritivo - 50g", quantity: 16 },
        { name: "NUTRITIVO 50G NIVEA - Creme Facial Nutritivo - 50g", quantity: 10 },
        { name: "NUTRITIVO 50G NIVEA - Creme Facial Nutritivo - 50g", quantity: 1 },
        { name: "NUTRITIVO 50G NIVEA - Creme Facial Nutritivo - 50g", quantity: 14 },
        { name: "NUTRITIVO 50G NIVEA - Creme Facial Nutritivo - 50g", quantity: 1 },
        { name: "NUTRITIVO 50G NIVEA - Creme Facial Nutritivo - 50g", quantity: 1 },
        { name: "Protetor Solar Nivea Sun Babies & Kids Sensitive Fps 60 100ml", quantity: 1, code: "4005900687241" },
        { name: "Gel Para Cicatrizes e Estrias Para Corpo e Rosto Cicatricure 30g", quantity: 1, code: "7898949409625" },
        { name: "Gel Creme para Pentear Kolene Curvaturas 500ml", quantity: 2, code: "7908324404098" },
        { name: "CICATRICURE - ANTISSINAIS 30G Cicatricure Creme Facial Antissinais 30g", quantity: 1 },
        { name: "CICATRICURE - GEL P/ CICATRIZES 30G Gel Para Cicatrizes e Estrias Para Corpo e Rosto Cicatricure 30g", quantity: 2 },
        { name: "CICATRICURE CONTORNO DE OLHOS 15G Creme Contorno Olhos Rugas Bolsas Olheiras 15g Cicatricure", quantity: 1 },
        { name: "FACIAL 100G NUTRITIVO + NOTURNO NIVEA - Kit 2 Unidades Creme Facial 100g", quantity: 2 },
        { name: "FACIAL NIVEA NOTURNO 100G NIVEA - Creme Facial 100g - Antissinais - Nutritivo - Noturno", quantity: 1 },
        { name: "FACIAL NIVEA PELE NEGRA 100G NIVEA - Creme Hidratante Facial Beleza Radiante 7 em 1 - 100g", quantity: 1 },
        { name: "H&S - SH ANTICASPA LIMP EFICAZ 400ML HEAD & SHOULDERS - Shampoo Anticaspa Limpeza Eficaz - 400ML", quantity: 1 },
        { name: "ISACARE - LABIAL C/ 2-MELANCIA- ISACARE-CEREJA - ISACARE ISACARE - Kit com 2 Unidades de Protetor Labial FPS 15 3,5g", quantity: 1 },
        { name: "ISACARE - LABIAL KIT C/ 2-AMORA - ISACARE-CEREJA - ISACARE ISACARE - Kit com 2 Unidades de Protetor Labial FPS 15 3,5g", quantity: 1 },
        { name: "ISACARE - LABIAL KIT C/ 2-CEREJA - ISACARE-CEREJA - ISACARE ISACARE - Kit com 2 Unidades de Protetor Labial FPS 15 3,5g", quantity: 1 },
        { name: "ISACARE - LABIAL KIT C/ 2-CEREJA - ISACARE-MELANCIA - ISACARE ISACARE - Kit com 2 Unidades de Protetor Labial FPS 15 3,5g", quantity: 1 },
        { name: "ISACARE - LABIAL KIT C/ 2-MELANCIA - ISACARE-AMORA - ISACARE ISACARE - Kit com 2 Unidades de Protetor Labial FPS 15 3,5g", quantity: 1 },
        { name: "ISACARE - LABIAL KIT C/ 2-MORANGO - ISACARE-CEREJA - ISACARE ISACARE - Kit com 2 Unidades de Protetor Labial FPS 15 3,5g", quantity: 1 },
        { name: "ISACARE - LABIAL KIT C/ 2-MORANGO - ISACARE-MELANCIA - ISACARE ISACARE - Kit com 2 Unidades de Protetor Labial FPS 15 3,5g", quantity: 1 },
        { name: "ISACARE - LABIAL KIT C/ 2-MORANGO - ISACARE-MORANGO - ISACARE ISACARE - Kit com 2 Unidades de Protetor Labial FPS 15 3,5g", quantity: 3 },
        { name: "ISACARE - LABIAL KIT C/ 2-MORANGO - ISACARE-UVA - ISACARE ISACARE - Kit com 2 Unidades de Protetor Labial FPS 15 3,5g", quantity: 1 },
        { name: "ISACARE - LABIAL-CEREJA- ISACARE ISACARE - Protetor Labial FPS15/50", quantity: 1 },
        { name: "ISACARE - LABIAL-MELANCIA - ISACARE ISACARE - Protetor Labial FPS 15/50", quantity: 1 },
        { name: "ISACARE - LABIAL-UVA VERDE- ISACARE ISACARE - Protetor Labial FPS15/50", quantity: 1 },
        { name: "KIT ANTISSINAIS + NUTRITIVO 50G NIVEA - Creme Facial Nutritivo - 50g", quantity: 1 },
        { name: "KIT ANTISSINAIS + NUTRITIVO 50G NIVEA - Creme Facial Nutritivo - 50g", quantity: 2 },
        { name: "KIT ANTISSINAIS + NUTRITIVO 50G NIVEA - Creme Facial Antissinais - 50g", quantity: 2 },
        { name: "KIT CICATRICURE CR 250G + GEL 30G Kit Cicatricure Antiestrias Creme 250g + Cicatricure Gel 30g", quantity: 1 },
        { name: "KIT GOLD LIFT DIURNO + NOTURNO CICATRICURE - Kit Gold Lift Creme Noturno 50g + Creme Diurno 50g", quantity: 1 },
        { name: "KIT TIO NACHO RECONSTRUTOR Tio Nacho Kit Reconstrutor SH 415mL + Cond 200mL", quantity: 2 },
        { name: "NEUTROGENA - FPS 70 200ML C/ 2 NEUTROGENA - Kit com 2 Protetores Solar Corporal Sun Fresh FPS 70 200ml", quantity: 3 },
        { name: "NIVEA - FPS 30 - 100ML NIVEA - Protetor Solar Protect & Hidrata FPS 30 - 100ml", quantity: 1 },
        { name: "NIVEA - FPS 30 - 100ML NIVEA - Protetor Solar Protect & Hidrata FPS 30 - 100ml", quantity: 1 },
        { name: "NIVEA - KIT ANTISSINAIS 50G + FACIAL TOQ SECO FPS 70 40G Kit Nivea Protetor Solar Facial Toque Seco FPS70 40ml + Creme Facial Antissinais 50g", quantity: 5 },
        { name: "NIVEA - KIT ANTISSINAIS 50G + FACIAL TOQ SECO FPS 70 40G Kit Nivea Protetor Solar Facial Toque Seco FPS70 40ml + Creme Facial Antissinais 50g", quantity: 2 },
        { name: "PANTENE - ÓLEO MILAGROSO 95ML Óleo Capilar Pantene Milagroso Queratina Leav-in 95ml", quantity: 1 },
        { name: "SH + COND + CR PENTEAR PANTENE B3 PANTENE - Kit GRANDE Shampoo 300ml e Condicionador 250ml - Antiqueda & Nutric...", quantity: 1 },
        { name: "SH + COND + CR PENTEAR PANTENE B3 PANTENE - Kit GRANDE Shampoo 300ml e Condicionador 250ml - Antiqueda & Nutric...", quantity: 1 },
        { name: "SOLAR LOREAL EFEITO MAKE UP-2.0 Protetor Facial L'Oréal Solar Expertise FPS 70 Efeito Makeup C/ Cor 30g", quantity: 1 },
        { name: "TONICO B3 TÔNICO CAPILAR PANTENE ANTIQUEDA BIOTINAMIDA B3 52ml", quantity: 1 }
    ];
}

// Substituir a função processExtractedProducts pela versão melhorada
function processExtractedProducts(products) {
    // Agrupar produtos com nomes similares
    const groupedProducts = groupSimilarProducts(products);
    
    // Comparar produtos extraídos com produtos cadastrados
    importedProducts = groupedProducts.map(product => {
        const match = findProductMatch(product, registeredProducts);
        
        return {
            originalName: product.name,
            name: match ? match.name : product.name,
            quantity: product.quantity,
            code: match ? match.code : "indisponível",
            status: match ? "encontrado" : "não encontrado"
        };
    });
    
    // Exibir resultados da análise
    displayAnalysisResults(importedProducts);
    
    // Mostrar card de produtos importados
    document.getElementById('importedProductsCard').style.display = 'block';
    
    showNotification('success', `Análise concluída! ${importedProducts.length} produtos encontrados.`);
}

// Substituir a função groupSimilarProducts pela versão melhorada
function groupSimilarProducts(products) {
    const grouped = {};
    
    products.forEach(product => {
        const normalizedName = normalizeProductName(product.name);
        
        if (grouped[normalizedName]) {
            grouped[normalizedName].quantity += product.quantity;
        } else {
            grouped[normalizedName] = {
                name: product.name,
                quantity: product.quantity,
                code: product.code || "indisponível"
            };
        }
    });
    
    return Object.values(grouped);
}

// Substituir a função normalizeProductName pela versão melhorada
function normalizeProductName(name) {
    return name.trim()
        .toUpperCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remover acentos
        .replace(/[^A-Z0-9\s]/g, '') // Remover caracteres especiais
        .replace(/\s+/g, ' ') // Remover espaços múltiplos
        .replace(/^\d+\*UND\s*/i, '') // Remover prefixos como "01*UND"
        .replace(/\s×\s*\d+$/, ''); // Remover sufixos de quantidade
}

// Substituir a função findProductMatch pela versão melhorada
function findProductMatch(importedProduct, registeredProducts) {
    const normalizedImported = normalizeProductName(importedProduct.name);
    
    // Primeiro, tentar encontrar por código
    if (importedProduct.code !== "indisponível") {
        const codeMatch = registeredProducts.find(p => p.code === importedProduct.code);
        if (codeMatch) return codeMatch;
    }
    
    // Depois, tentar encontrar correspondência exata no nome
    let match = registeredProducts.find(p => 
        normalizeProductName(p.name) === normalizedImported
    );
    
    if (match) return match;
    
    // Se não encontrar correspondência exata, procurar por palavras-chave
    const importedWords = normalizedImported.split(' ').filter(word => word.length > 2);
    
    for (const registeredProduct of registeredProducts) {
        const normalizedRegistered = normalizeProductName(registeredProduct.name);
        const registeredWords = normalizedRegistered.split(' ').filter(word => word.length > 2);
        
        // Verificar se há sobreposição significativa de palavras
        const commonWords = importedWords.filter(word => 
            registeredWords.includes(word)
        );
        
        // Se houver pelo menos 2 palavras em comum, considerar como correspondência
        if (commonWords.length >= 2) {
            return registeredProduct;
        }
    }
    
    // Se nenhuma correspondência for encontrada
    return null;
}

// Substituir a função displayAnalysisResults pela versão melhorada
function displayAnalysisResults(products) {
    const resultsContainer = document.getElementById('analysisResults');
    const previewContainer = document.getElementById('productPreview');
    
    if (products.length === 0) {
        resultsContainer.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h4>Nenhum produto encontrado</h4>
                <p>O PDF não contém produtos reconhecíveis</p>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="progress-container">
            <h4>Resumo da Análise</h4>
            <div class="progress-count">
                <div class="count-item">
                    <span class="count-value">${products.length}</span>
                    <span class="count-label">Total</span>
                </div>
                <div class="count-item">
                    <span class="count-value count-completed">${products.filter(p => p.status === 'encontrado').length}</span>
                    <span class="count-label">Encontrados</span>
                </div>
                <div class="count-item">
                    <span class="count-value count-pending">${products.filter(p => p.status === 'não encontrado').length}</span>
                    <span class="count-label">Não Encontrados</span>
                </div>
            </div>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" style="width: ${(products.filter(p => p.status === 'encontrado').length / products.length) * 100}%"></div>
        </div>
    `;
    
    resultsContainer.innerHTML = html;
    
    // Atualizar prévia dos produtos
    previewContainer.innerHTML = '';
    products.forEach(product => {
        const productElement = document.createElement('div');
        productElement.className = 'product-preview-item';
        productElement.innerHTML = `
            <div>
                <strong>${product.name}</strong>
                <div>Quantidade: ${product.quantity} • Código: ${product.code}</div>
            </div>
            <span class="product-match ${product.status === 'encontrado' ? 'match-found' : 'match-notfound'}">
                ${product.status === 'encontrado' ? '✓' : '✗'}
            </span>
        `;
        previewContainer.appendChild(productElement);
    });
}
        // Função para salvar lista importada
        function saveImportedList() {
            if (importedProducts.length === 0) {
                showNotification('error', 'Nenhum produto para salvar.');
                return;
            }
            const listName = document.getElementById('listName').value.trim() || `Lista_${new Date().toLocaleDateString()}`;
            const listProducts = importedProducts.map(p => ({
                name: p.name,
                code: p.code,
                isKit: p.isKit,
                kitCodes: p.kitCodes,
                quantity: p.quantity,
                separated: 0
            }));
            lists[listName] = { name: listName, products: listProducts, date: new Date().toISOString() };
            localStorage.setItem('lists', JSON.stringify(lists));
            updateListSelector();
            showNotification('success', `Lista "${listName}" salva com sucesso!`);
            clearFile();
        }
        
        // Função para carregar listas salvas
        function loadSavedLists() {
            updateListSelector();
        }
        
        // Função para atualizar o seletor de listas
        function updateListSelector() {
            const listSelector = document.getElementById('lista-selecionada');
            const currentSelection = listSelector.value;
            while (listSelector.options.length > 1) listSelector.remove(1);
            Object.keys(lists).forEach(listName => {
                const option = document.createElement('option');
                option.value = listName;
                option.textContent = listName;
                listSelector.appendChild(option);
            });
            if (currentSelection && lists[currentSelection]) {
                listSelector.value = currentSelection;
            }
        }
        
        // Função para carregar a lista selecionada
        function loadSelectedList() {
            const listName = document.getElementById('lista-selecionada').value;
            if (listName && lists[listName]) {
                currentList = lists[listName];
                
                // Redefinir filtro e botões ao carregar uma nova lista
                currentFilter = 'all';
                document.querySelectorAll('.filter-buttons .filter-button').forEach(btn => btn.classList.remove('active'));
                document.querySelector('.filter-buttons button[onclick^="filterProducts(\'all\'"]').classList.add('active');
                
                updateProductsList();
                document.getElementById('finish-button').disabled = true;
                startTime = null;
            } else {
                currentList = null;
                document.getElementById('products-list').innerHTML = '<p>Selecione uma lista para começar</p>';
            }
        }
        
        // Função para atualizar a lista de produtos na UI
        function updateProductsList() {
            const productsList = document.getElementById('products-list');
            const pendingCount = document.getElementById('pending-count');
            const completedCount = document.getElementById('completed-count');
            const progressFill = document.getElementById('progress-fill');
            if (!currentList || !currentList.products) {
                productsList.innerHTML = '<p>Nenhum produto na lista</p>';
                return;
            }
            
            let totalToSeparate = 0, totalSeparated = 0;
            productsList.innerHTML = '';
            
            currentList.products.forEach((product, index) => {
                totalToSeparate += product.quantity;
                totalSeparated += product.separated;
                const isCompleted = product.separated >= product.quantity;

                // Aplica o filtro de visualização
                if (currentFilter === 'pending' && isCompleted) {
                    return; // Pula a renderização de itens concluídos se o filtro for "pendentes"
                }
                if (currentFilter === 'completed' && !isCompleted) {
                    return; // Pula a renderização de itens pendentes se o filtro for "concluídos"
                }

                const progressPercent = product.quantity > 0 ? (product.separated / product.quantity) * 100 : 0;
                const productElement = document.createElement('div');
                productElement.className = 'product-item';
                productElement.innerHTML = `
                    <div class="product-info">
                        <div class="status-indicator ${isCompleted ? 'status-completed' : 'status-pending'}"></div>
                        <div>
                            <strong>${product.name}</strong>
                            <div class="product-quantity">
                                <span>${product.separated}/${product.quantity}</span>
                                <div class="quantity-progress"><div class="quantity-progress-fill" style="width: ${progressPercent}%"></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="manual-quantity-controls">
                        <button class="quantity-btn remove" onclick="manualRemoveUnit(${index})">-</button>
                        <button class="quantity-btn" onclick="manualAddUnit(${index})">+</button>
                    </div>`;
                productsList.appendChild(productElement);
            });
            
            pendingCount.textContent = totalToSeparate - totalSeparated;
            completedCount.textContent = totalSeparated;
            progressFill.style.width = `${totalToSeparate > 0 ? (totalSeparated / totalToSeparate) * 100 : 0}%`;
            checkCompletion();
        }
        
        // Função para adicionar unidade manualmente
        function manualAddUnit(index) {
            if (currentList && currentList.products && currentList.products[index]) {
                if (!startTime) startTime = new Date();
                const product = currentList.products[index];
                if (product.separated < product.quantity) {
                    product.separated++;
                    lists[currentList.name] = currentList;
                    localStorage.setItem('lists', JSON.stringify(lists));
                    updateProductsList();
                } else {
                    showNotification('warning', `Quantidade máxima já separada para "${product.name}".`);
                }
            }
        }
        
        // Função para remover unidade manually
        function manualRemoveUnit(index) {
            if (currentList?.products?.[index]?.separated > 0) {
                currentList.products[index].separated--;
                lists[currentList.name] = currentList;
                localStorage.setItem('lists', JSON.stringify(lists));
                updateProductsList();
            }
        }
        
        // Função para verificar se a separação foi concluída
        function checkCompletion() {
            if (currentList?.products) {
                const allSeparated = currentList.products.every(p => p.separated >= p.quantity);
                document.getElementById('finish-button').disabled = !allSeparated;
                if (allSeparated) showNotification('success', 'Todos os itens foram separados!');
            }
        }
        
        // Função para finalizar a separação
        function finishSeparation() {
            if (currentList) {
                endTime = new Date();
                saveReport();
                showReport();
                currentList = null;
                startTime = null;
                endTime = null;
            }
        }
        
        // Função para iniciar a separação de itens
        function startSeparation() { showScreen('separacao-itens'); }
        
        // Função para cancelar a separação
        function cancelSeparation() {
            if (scannerActive) stopBarcodeScanner();
            showScreen('main-screen');
        }
        
        // Função para adicionar um novo produto
        function addProduct() {
            const name = document.getElementById('product-name').value.trim();
            const code = document.getElementById('product-code').value.trim();
            if (!name || !code) {
                showNotification('error', 'Nome e código são obrigatórios.');
                return;
            }
            if (registeredProducts.some(p => p.code === code)) {
                showNotification('error', 'Produto com este código já existe.');
                return;
            }
            registeredProducts.push({ name, code, isKit: false });
            saveRegisteredProducts();
            document.getElementById('product-name').value = '';
            document.getElementById('product-code').value = '';
            showNotification('success', 'Produto adicionado!');
            loadRegisteredProducts();
        }
        
        // Funções de importação de produtos
        function handleProductsFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type === 'text/plain') {
                const reader = new FileReader();
                reader.onload = e => document.getElementById('products-content-import').value = e.target.result;
                reader.readAsText(file);
            } else {
                showNotification('error', 'Selecione um arquivo TXT.');
            }
        }

        function importProducts() {
            const content = document.getElementById('products-content-import').value.trim();
            if (!content) return;
            let importedCount = 0, skippedCount = 0;
            content.split('\n').forEach(line => {
                const parts = line.split(',');
                if (parts.length < 2) return;
                const name = parts.shift().trim();
                const codePart = parts.join(',').trim();
                if (!name || !codePart) return;
                
                const isKit = codePart.includes('/');
                let product, exists;
                if (isKit) {
                    const kitCodes = codePart.split('/').map(c => c.trim());
                    exists = kitCodes.some(kc => registeredProducts.some(p => (p.isKit && p.kitCodes.includes(kc)) || p.code === kc));
                    if (!exists) product = { name, code: kitCodes[0], isKit: true, kitCodes };
                } else {
                    exists = registeredProducts.some(p => (p.isKit && p.kitCodes.includes(codePart)) || p.code === codePart);
                    if (!exists) product = { name, code: codePart, isKit: false };
                }

                if (product) {
                    registeredProducts.push(product);
                    importedCount++;
                } else {
                    skippedCount++;
                }
            });
            if (importedCount > 0) {
                saveRegisteredProducts();
                loadRegisteredProducts();
                showNotification('success', `${importedCount} produtos importados. ${skippedCount} ignorados.`);
            } else {
                showNotification('warning', 'Nenhum produto novo importado.');
            }
        }

        function saveRegisteredProducts() {
            localStorage.setItem('registeredProducts', JSON.stringify(registeredProducts));
        }

        // Função para carregar produtos cadastrados
        function loadRegisteredProducts() {
            const container = document.getElementById('products-list-registered');
            container.innerHTML = '';
            if (registeredProducts.length === 0) {
                container.innerHTML = `<div class="empty-state">...</div>`;
                return;
            }
            registeredProducts.forEach(p => {
                const codeDisplay = p.isKit ? `Código(s): ${p.kitCodes.join(', ')}` : `Código: ${p.code}`;
                container.innerHTML += `
                    <div class="list-item">
                        <div><strong>${p.name}</strong><div>${codeDisplay}</div></div>
                        <button class="action-btn btn-delete" onclick="deleteProduct('${p.code}')"><i class="fas fa-trash"></i></button>
                    </div>`;
            });
        }
        
        // Função para buscar produtos
        function searchProducts(query) {
            const container = document.getElementById('products-list-registered');
            const lowerQuery = query.toLowerCase();
            const filtered = registeredProducts.filter(p => 
                p.name.toLowerCase().includes(lowerQuery) || p.code.toLowerCase().includes(lowerQuery) ||
                (p.isKit && p.kitCodes.some(kc => kc.toLowerCase().includes(lowerQuery)))
            );
            container.innerHTML = '';
            if (filtered.length > 0) {
                filtered.forEach(p => {
                    const codeDisplay = p.isKit ? `Código(s): ${p.kitCodes.join(', ')}` : `Código: ${p.code}`;
                    container.innerHTML += `
                        <div class="list-item">
                            <div><strong>${p.name}</strong><div>${codeDisplay}</div></div>
                            <button class="action-btn btn-delete" onclick="deleteProduct('${p.code}')"><i class="fas fa-trash"></i></button>
                        </div>`;
                });
            } else {
                container.innerHTML = `<div class="empty-state"><h4>Nenhum produto encontrado</h4></div>`;
            }
        }
        
        // Função para excluir produto
        function deleteProduct(code) {
            if (confirm('Tem certeza?')) {
                registeredProducts = registeredProducts.filter(p => p.code !== code);
                saveRegisteredProducts();
                loadRegisteredProducts();
                showNotification('success', 'Produto excluído.');
            }
        }
        
        // Funções do scanner de código de barras
        function initBarcodeScanner() {
            if (scannerActive) return;
            const scannerPlaceholder = document.getElementById('scanner-placeholder');
            scannerPlaceholder.style.display = 'none';
            Quagga.init({
                inputStream: { name: "Live", type: "LiveStream", target: '#barcode-scanner', constraints: { width: 480, height: 320, facingMode: "environment" }},
                decoder: { readers: ["code_128_reader", "ean_reader"] }
            }, err => {
                if (err) {
                    showNotification('error', 'Erro ao iniciar câmera.');
                    scannerPlaceholder.style.display = 'flex';
                    return;
                }
                scannerActive = true;
                document.getElementById('start-scanner').classList.add('inactive');
                document.getElementById('stop-scanner').classList.remove('inactive');
                Quagga.start();
            });
            Quagga.onDetected(result => {
                if (!canScan) return;
                const code = result.codeResult.code;
                canScan = false;
                setTimeout(() => canScan = true, 1000);
                processScannedBarcode(code);
            });
        }
        function stopBarcodeScanner() {
            if (scannerActive) {
                Quagga.stop();
                scannerActive = false;
                document.getElementById('scanner-placeholder').style.display = 'flex';
                document.getElementById('start-scanner').classList.remove('inactive');
                document.getElementById('stop-scanner').classList.add('inactive');
            }
        }
        function processScannedBarcode(scannedCode) {
            if (!currentList) {
                showNotification('error', 'Nenhuma lista selecionada.');
                return;
            }
            const productIndex = currentList.products.findIndex(p => (p.isKit && p.kitCodes.includes(scannedCode)) || p.code === scannedCode);
            if (productIndex !== -1) {
                manualAddUnit(productIndex);
                showNotification('success', `Código ${scannedCode} processado!`);
            } else {
                showNotification('error', `Produto com código ${scannedCode} não encontrado.`);
            }
        }
        function handleBarcodeInput(event) { if (event.key === 'Enter') processBarcode(); }
        function processBarcode() {
            const input = document.getElementById('barcode-input');
            if (input.value.trim()) {
                processScannedBarcode(input.value.trim());
                input.value = '';
            }
        }
        
        // Funções de filtro e ordenação
        function filterProducts(filter, element) {
            currentFilter = filter;
            // Atualiza a classe 'active' para os botões de filtro
            const filterButtons = document.querySelectorAll('.filter-buttons button[onclick^="filterProducts"]');
            filterButtons.forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            updateProductsList();
        }

        function sortProducts(criteria, element) {
            if (!currentList || !currentList.products) {
                showNotification('error', 'Nenhuma lista selecionada para ordenar.');
                return;
            }
            if (criteria === 'name') {
                currentList.products.sort((a, b) => a.name.localeCompare(b.name));
            } else if (criteria === 'quantity') {
                currentList.products.sort((a, b) => b.quantity - a.quantity);
            }
            // Atualiza a classe 'active' para os botões de ordenação
            const sortButtons = document.querySelectorAll('.filter-buttons button[onclick^="sortProducts"]');
            sortButtons.forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            
            showNotification('success', `Lista ordenada por ${criteria === 'name' ? 'Nome' : 'Quantidade'}.`);
            updateProductsList();
        }

        // Funções de Relatório
        function saveReport() {
            const timeDiff = endTime - startTime;
            const report = {
                id: Date.now(),
                operator: currentOperator,
                listName: currentList.name,
                date: new Date().toLocaleDateString('pt-BR'),
                startTime: startTime.toLocaleTimeString('pt-BR'),
                endTime: endTime.toLocaleTimeString('pt-BR'),
                duration: `${Math.floor(timeDiff / 60000)}min ${Math.floor((timeDiff % 60000) / 1000)}s`,
                itemsProcessed: `${currentList.products.reduce((t, p) => t + p.separated, 0)}/${currentList.products.reduce((t, p) => t + p.quantity, 0)}`,
                efficiency: `${Math.round((currentList.products.reduce((t, p) => t + p.separated, 0) / currentList.products.reduce((t, p) => t + p.quantity, 0)) * 100)}%`,
                products: currentList.products
            };
            const reports = JSON.parse(localStorage.getItem('completedReports') || '[]');
            reports.push(report);
            localStorage.setItem('completedReports', JSON.stringify(reports));
            completedReports = reports;
        }
        function loadReports() {
            const container = document.getElementById('reports-list');
            const reports = JSON.parse(localStorage.getItem('completedReports') || '[]');
            completedReports = reports;
            container.innerHTML = '';
            if (reports.length === 0) {
                container.innerHTML = `<div class="empty-state">Nenhum relatório.</div>`;
                return;
            }
            reports.sort((a, b) => b.id - a.id).forEach(r => {
                container.innerHTML += `
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-name">${r.listName}</div>
                            <div class="file-details">${r.date} • ${r.duration}</div>
                        </div>
                        <div class="file-actions">
                            <button class="action-btn btn-view" onclick="viewReport(${r.id})"><i class="fas fa-eye"></i></button>
                        </div>
                    </div>`;
            });
        }
        function viewReport(reportId) {
            const report = completedReports.find(r => r.id === reportId);
            if (!report) return;
            document.getElementById('report-responsavel').textContent = report.operator;
            document.getElementById('report-data').textContent = report.date;
            document.getElementById('report-inicio').textContent = report.startTime;
            document.getElementById('report-termino').textContent = report.endTime;
            document.getElementById('report-tempo').textContent = report.duration;
            document.getElementById('report-itens').textContent = report.itemsProcessed;
            document.getElementById('report-eficiencia').textContent = report.efficiency;
            document.getElementById('reportModal').setAttribute('data-current-report', reportId);
            document.getElementById('reportModal').style.display = 'flex';
        }
        function exportReport() {
            const reportId = parseInt(document.getElementById('reportModal').getAttribute('data-current-report'));
            const report = completedReports.find(r => r.id === reportId);
            if (!report) return;
            let text = `Relatório - ${report.listName}\n========================\n`;
            text += `Operador: ${report.operator}\nData: ${report.date}\n`;
            text += `Duração: ${report.duration}\nItens: ${report.itemsProcessed}\n\n`;
            report.products.forEach(p => text += `- ${p.name}: ${p.separated}/${p.quantity}\n`);
            const blob = new Blob([text], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `relatorio-${report.id}.txt`;
            a.click();
        }
        function closeReport() {
            document.getElementById('reportModal').style.display = 'none';
            showScreen('main-screen');
        }
        function showReport() {
            const reportId = completedReports[completedReports.length - 1]?.id || Date.now();
            viewReport(reportId);
        }
    </script>
</body>
</html>
